{"componentChunkName":"component---src-templates-example-js","path":"/prometheus/","webpackCompilationHash":"4c97b8867ce8cc5e8d2c","result":{"data":{"site":{"siteMetadata":{"title":"Istio By Example","author":"Megan O'Keefe"}},"markdownRemark":{"id":"ff4e1bac-782f-5791-9844-b804046dcc99","excerpt":"Prometheus is an open-source monitoring tool. By default, Prometheus is installed alongside Istio, allowing you to use Grafana and Kiali to view metrics for…","html":"<p><a href=\"https://prometheus.io/docs/introduction/overview/\">Prometheus</a> is an open-source monitoring tool. By default, Prometheus is installed alongside Istio, allowing you to use Grafana and Kiali to view metrics for both the Istio control plane and your Envoy-injected workloads.</p>\n<p>But what if you’re already running Prometheus on your cluster, or you want to add extra customization to Istio’s Prometheus installation (for instance, add <a href=\"https://prometheus.io/docs/alerting/notification_examples/#customizing-slack-notifications\">Slack notifications</a> for Istio )?</p>\n<p>Not to worry. You can bring your own Prometheus to Istio, with three quick steps.</p>\n<p>First, <strong>update your Prometheus configuration.</strong> Prometheus relies on a <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config\">scrape config model</a>, where <code class=\"language-text\">targets</code> represent <code class=\"language-text\">/metrics</code> endpoints, ingested by the Prometheus server.</p>\n<p>We’ll add <code class=\"language-text\">targets</code> for <a href=\"https://istio.io/docs/tasks/telemetry/metrics/querying-metrics/\">each of the Istio components</a>, which are scraped <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config\">through the Kubernetes API server</a>. For instance, here is the configuration for Istio’s <a href=\"https://istio.io/docs/concepts/traffic-management/#pilot\">Pilot</a> component:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'pilot'</span>\n      <span class=\"token key atrule\">kubernetes_sd_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> endpoints\n        <span class=\"token key atrule\">namespaces</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">names</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> istio<span class=\"token punctuation\">-</span>system\n\n      <span class=\"token key atrule\">relabel_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__meta_kubernetes_service_name<span class=\"token punctuation\">,</span> __meta_kubernetes_endpoint_port_name<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">action</span><span class=\"token punctuation\">:</span> keep\n        <span class=\"token key atrule\">regex</span><span class=\"token punctuation\">:</span> istio<span class=\"token punctuation\">-</span>pilot;http<span class=\"token punctuation\">-</span>monitoring</code></pre></div>\n<p>See <a href=\"https://github.com/askmeegs/istiobyexample/blob/888a7b5c573c9ba6bf2c0e046e44bf4f8d8d2506/content/blog/prometheus/configmap.yaml\">configmap.yaml</a> for a full example.</p>\n<p>Second, <strong>update your Prometheus deployment</strong> to mount Istio’s certificates into Prometheus. This allows Prometheus to scrape Istio workloads when mutual TLS is enabled. To do this, mount in the <code class=\"language-text\">istio.default</code> secret into your Prometheus deployment YAML:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">-</span>volume\n        <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> prometheus\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> istio<span class=\"token punctuation\">-</span>certs\n        <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">defaultMode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">420</span>\n            <span class=\"token key atrule\">optional</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n            <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> istio.default</code></pre></div>\n<p>See <a href=\"https://github.com/askmeegs/istiobyexample/blob/888a7b5c573c9ba6bf2c0e046e44bf4f8d8d2506/content/blog/prometheus/deployment.yaml\">deployment.yaml</a> for the full example.</p>\n<p>Once we deploy Prometheus with this new configuration, we have a Deployment and a Service running in a separate <code class=\"language-text\">monitoring</code> namespace:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl get <span class=\"token function\">service</span> -n monitoring\n\nNAME         TYPE           CLUSTER-IP   EXTERNAL-IP      PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>          AGE\nprometheus   LoadBalancer   10.0.3.155   <span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span>             9090:32352/TCP   21m</code></pre></div>\n<p>Lastly, <strong>update Istio’s configuration</strong> to use a custom Prometheus address. Here’s a <a href=\"https://istio.io/docs/setup/kubernetes/install/helm/\"><code class=\"language-text\">helm template</code></a> example using the <a href=\"https://istio.io/docs/reference/config/installation-options/#grafana-options\">Istio installation options</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">helm template install/kubernetes/helm/istio --name istio --namespace istio-system \\\n--set prometheus.enabled<span class=\"token operator\">=</span>false \\\n--set kiali.enabled<span class=\"token operator\">=</span>true --set kiali.createDemoSecret<span class=\"token operator\">=</span>true \\\n--set kiali.prometheusAddr<span class=\"token operator\">=</span><span class=\"token string\">\"http://prometheus.monitoring.svc.cluster.local:9090\"</span> \\\n--set <span class=\"token string\">\"kiali.dashboard.jaegerURL=http://jaeger-query:16686\"</span> \\\n--set <span class=\"token string\">\"kiali.dashboard.grafanaURL=http://grafana:3000\"</span> \\\n--set grafana.enabled<span class=\"token operator\">=</span>true \\\n--set grafana.datasources.datasources.datasources.url<span class=\"token operator\">=</span><span class=\"token string\">\"http://prometheus.monitoring.svc.cluster.local:9090\"</span>  <span class=\"token operator\">></span> istio.yaml</code></pre></div>\n<p>Once Istio and Prometheus are both installed, and we deploy some Istio-injected workloads to our cluster, we can see that Prometheus is successfully scraping our Istio targets:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/ec21f/prometheus.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.90424570912376%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACRElEQVQoz3VS227TQBD1j1Ek2oc0ohUSD0j8EH/BA08gwRvlqVxEHypEaUEEgtMEUqe2114ntuPrXuzDeN0bUlnpaGZ3zs7O7Bnr4aPHGO48wPD+Lra2d7E52MW9wQ7ubg1xZ3OAjc1tsrdj4wId73Jv/Zgv8eF7gCd7DPacIQwYPJ/BZ4GB6/lgZDt45Hv+NdyLPQvCK661TDKIFohr/LOqukZd94dFWSErKvxvxXGMsiyNb03cFIuoxCwoceqXKIqCghXCOAKPl1B1hfF5hr1Ribe2xLuJICtw7NSoKMk6y3B25oBzbpJaLAOivMUnp8Wz4xZNQ+WivXq9ba/9hvwu3B/1vBthw7WiKILWGlopOlJQUpr9Ml5hRa10l9wwgX2eIMgasFQRNLxEo6i1+RZnsQCnPIruWbZf4Q8XOHEEXo9q5GUNKQTiLEWSr9FIgVlYY99W+DjTOPitDN5PNVgiIOqSRAmQpmsIumd5icJaAE4C7E8BoS/Kb9ob7WpT/W2rYzRNY2BEcTyOtOgqIkVbgq7oJQmfMzAeElth7KywP0pwtNA4ciS+OAqHc4UgFSRMjrE9MSNlKjzlwJgpnC0VXnxVeDOWJolQElIr+luJuGwxXQKnXGMWNQSNCW+QFH28K0CRBpJgrbPcKNcVHxUtwqxvs6q6ORS9uoJmrC0utb5s1FhNreZ5Tvx+Ti2b2jmnOZyHJVZpAVHlZg5d7lPbAYlS4/MswdPDHC+/KYLEK8LzE4mDqUCerfFz/Auu65k5/AvFRmucRYOAHgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"prometheus\"\n        title=\"prometheus\"\n        src=\"/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/b9e4f/prometheus.png\"\n        srcset=\"/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/cf440/prometheus.png 148w,\n/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/d2d38/prometheus.png 295w,\n/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/b9e4f/prometheus.png 590w,\n/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/f9b6a/prometheus.png 885w,\n/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/2d849/prometheus.png 1180w,\n/static/6cd62a6d2ce9f4c89cd2b5ae76e96256/ec21f/prometheus.png 2214w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>Grafana can fetch service-level metrics:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/66b70fe32ec5fd197a44cae778397d0c/a16be/grafana.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.17056856187291%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7ElEQVQoz2VS2W7bMBDUP8SyrfsixUuHHR+Ca8dNkxToS9HH/v+XTIeMCxTow2B3qeXuzFCRMQ5l1UBIBdlr9MogSXPE6y3WD4R8k/yHDeG/JUkGIXq0nUS0rQW2aYHtNsWGWG94mQ2FGVHYCbnQWK3WSDqFlPnTU4ykkciUQ6YdYvZuSMD3po1A5C9vieQRPQKDR2PMJU0rYIcJZhihjYVxI5QdoH3UFklWfPYTUfyQ5LGKN1j9U8e+XpFRkiLPM2QpY5YROXPGNAtx/beXiHJOL4sKiv5pbuvoQ8E6y0rUnYabDujNBKFHMnxG2fTIixpV3dE3BWvJmtIrvoNHVOtn1G7BeH7F9f0nzOGOZryhkgPE/AJ1/I7bj98BmrmYv9IChf35jOm8wE57PqQNjzmME6Kq34UBcnfHvLxDzjfWV5RiQKMPaOwCd/qG4fga8sYc+Vd0MNZw6Al2nqliQse/JM8rSs5LVOWnZA9Byd4Cf940LZx14VzKHoPjkroN0upWQvLVHSUbM6Dmec1+Sj6gHi6YljfcPn5RMiVNd1Rk2PYjGjXjfH3D5eUDrdoRExdJ7Bdv0wI9zEGuhxu8ZMkGd0E3XeE4TIwXenpB2VkEf80Jav4CtbuG3BPwkrUxmI5HDiRDMm+FDJL/AEbUHYdMvVeKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grafana\"\n        title=\"grafana\"\n        src=\"/static/66b70fe32ec5fd197a44cae778397d0c/b9e4f/grafana.png\"\n        srcset=\"/static/66b70fe32ec5fd197a44cae778397d0c/cf440/grafana.png 148w,\n/static/66b70fe32ec5fd197a44cae778397d0c/d2d38/grafana.png 295w,\n/static/66b70fe32ec5fd197a44cae778397d0c/b9e4f/grafana.png 590w,\n/static/66b70fe32ec5fd197a44cae778397d0c/f9b6a/grafana.png 885w,\n/static/66b70fe32ec5fd197a44cae778397d0c/2d849/grafana.png 1180w,\n/static/66b70fe32ec5fd197a44cae778397d0c/a16be/grafana.png 2392w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>And Kiali can display the service graph:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14557765c931272eca374db6f58454fc/435fe/kiali.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.95078299776287%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABhklEQVQ4y31UiZKDIAz1/39yZ3Z6basoqNz4NsFqqdVmzBghPF4uq05K1I1A23bQxoBlmqYPTSkd2qVWWo+4CQUfImKMsNYhhLDq4lgeZpt9WbcEKqUULpcrmqaBEAKn0zm/67om5g1dYLMyuNYahqJgoL7vMQxDBiwZV3jKsvD8wHa91FK2e9XWabG3Bxdhdsx0mtLufrXH4EjBDwF57xFT2meIAzlimKYX0AL6xvAbGIf2oOKcbrdcJGb2StHsI0SL3/MFXNxdhiv9OT4YZ3HvFUYzYjBDvsRSpfk9GtoTHa6N/B5yWRgX3bpunMG9/sPP+UyMBQZt4HxY2a6ARwVgsJwzskMMucIhUfM7R/bc5Az40Ta7yUeEj/6Z/Nn2BMospZJwztMlMQOXUa0MFXV+R4kNdFANGq3qMytLOdRWZyD+ZsY5FQTI41qm5y3ktpN4tIKcHIQcULeSwvN00EL2Hay3a2PzKBrD4xg/WuwwZE4ch8nhpinO7MjOM01VXn4i27H9B02Enj8gmDAdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kiali\"\n        title=\"kiali\"\n        src=\"/static/14557765c931272eca374db6f58454fc/b9e4f/kiali.png\"\n        srcset=\"/static/14557765c931272eca374db6f58454fc/cf440/kiali.png 148w,\n/static/14557765c931272eca374db6f58454fc/d2d38/kiali.png 295w,\n/static/14557765c931272eca374db6f58454fc/b9e4f/kiali.png 590w,\n/static/14557765c931272eca374db6f58454fc/f9b6a/kiali.png 885w,\n/static/14557765c931272eca374db6f58454fc/2d849/kiali.png 1180w,\n/static/14557765c931272eca374db6f58454fc/435fe/kiali.png 1788w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"bring your own prometheus","date":"May 01, 2015"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/prometheus/","previous":null,"next":{"fields":{"slug":"/traffic-mirroring/"},"frontmatter":{"title":"traffic mirroring"}}}}}