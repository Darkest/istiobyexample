{"componentChunkName":"component---src-templates-example-js","path":"/traffic-mirroring/","webpackCompilationHash":"4c97b8867ce8cc5e8d2c","result":{"data":{"site":{"siteMetadata":{"title":"Istio By Example","author":"Megan O'Keefe"}},"markdownRemark":{"id":"969997a2-9c30-5b87-9e13-e96de2c2491e","excerpt":"Testing a service in production is important to help ensure reliability. Sending live production traffic to a new version of a service can help reveal bugs that…","html":"<p>Testing a service in production is important to help ensure reliability. Sending live production traffic to a new version of a service can help reveal bugs that went untested during continuous integration and functional tests.</p>\n<p>Using Istio, you can use <a href=\"https://istio.io/docs/tasks/traffic-management/mirroring/\"><strong>traffic mirroring</strong></a> to duplicate traffic to another service. You can incorporate a traffic mirroring rule as part of a <a href=\"https://istiobyexample.dev/canary\">canary deployment</a> pipeline, allowing you to analyze a service’s behavior before sending live traffic to it.</p>\n<p>In this example, we have deployed a video processing pipeline to Kubernetes. The <code class=\"language-text\">render</code> service has a dependency on the <code class=\"language-text\">encode-prod</code> service, and we want to roll out a new version of <code class=\"language-text\">encode</code>, <code class=\"language-text\">encode-test</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/031ce1539dfa83454bce2201ea1bec7e/e95bd/mirror.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.19798234552333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkklEQVQoz42S7XKbMBBF8/7P5kwmnTSO26a1E9uABUZfgIQEp7Jw0vZHmy5zZzTAHN29uzfzPPMvwUVczzBNkX42DFiGYHDBZoXJ5+83/LXm5XkHLxUJdKLG71rsJDG+5jwcUa5agHGaOciRUgVOJnC2gUaNSPdubnE2J1T0SF8iPq2ZNppy/0ThvtH0r7TuuAB7P7Ha9vwQnrUY0V/O2NuC41nTR4vyVXbQJmknKPtn6ocN8UEi9s+oKJK7U/4nA7sEvH8dkF1g2waGdc300vL9fo1wBb0zxHnM7WenqWljBV15wsSa1h9o3AtmrK8Ox4nbXc+hHdnUyeFOYe4qRJPabzXFsaCzHc75DB3H1LaV2NCjtaJtW6SUDMPwK8NKB0TKr0n5KTchh4hOzmNME+17lFJUVZUAOk3Wo75W+HWTLq3z+7IsaZrmoyn/Wd57rLVoozmvdkxbzXb1RNUItNIIIRbgR3v4+8pkcEixPBaEzw2nfZkvqOs667+Ab0v9dh7HtFIqZWgspjPIa4aXaC71E+R5BpF6VBozAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"traffic mirroring\"\n        title=\"traffic mirroring\"\n        src=\"/static/031ce1539dfa83454bce2201ea1bec7e/b9e4f/mirror.png\"\n        srcset=\"/static/031ce1539dfa83454bce2201ea1bec7e/cf440/mirror.png 148w,\n/static/031ce1539dfa83454bce2201ea1bec7e/d2d38/mirror.png 295w,\n/static/031ce1539dfa83454bce2201ea1bec7e/b9e4f/mirror.png 590w,\n/static/031ce1539dfa83454bce2201ea1bec7e/f9b6a/mirror.png 885w,\n/static/031ce1539dfa83454bce2201ea1bec7e/2d849/mirror.png 1180w,\n/static/031ce1539dfa83454bce2201ea1bec7e/e95bd/mirror.png 1586w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>We can use an Istio <code class=\"language-text\">VirtualService</code> to mirror all <code class=\"language-text\">encode-prod</code> traffic to <code class=\"language-text\">encode-test</code>. The client side Envoy proxy for <code class=\"language-text\">render</code> will then send requests to both <code class=\"language-text\">encode-prod</code> (request path) and <code class=\"language-text\">encode-test</code> (mirrored path). <code class=\"language-text\">prod</code> and <code class=\"language-text\">test</code> are two subsets of the <code class=\"language-text\">encode</code> Kubernetes service, specified in an Istio <code class=\"language-text\">DestinationRule</code>.</p>\n<p><strong>Note</strong>: <code class=\"language-text\">render</code> <a href=\"https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#route-routeaction-requestmirrorpolicy\">will not wait</a> to receive responses from <code class=\"language-text\">encode-test</code> — mirrored requests are “fire and forget.”</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.istio.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> VirtualService\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> encode<span class=\"token punctuation\">-</span>mirror\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> encode\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">route</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> encode\n        <span class=\"token key atrule\">subset</span><span class=\"token punctuation\">:</span> prod\n      <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n    <span class=\"token key atrule\">mirror</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> encode\n      <span class=\"token key atrule\">subset</span><span class=\"token punctuation\">:</span> test</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.istio.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> DestinationRule\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> encode\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> encode\n  <span class=\"token key atrule\">subsets</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> prod\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> prod\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> test</code></pre></div>","frontmatter":{"title":"traffic mirroring","date":"May 01, 2015"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/traffic-mirroring/","previous":{"fields":{"slug":"/authorization/"},"frontmatter":{"title":"authorization"}},"next":{"fields":{"slug":"/jwt/"},"frontmatter":{"title":"jwt"}}}}}