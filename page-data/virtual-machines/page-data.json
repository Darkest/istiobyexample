{"componentChunkName":"component---src-templates-example-js","path":"/virtual-machines/","webpackCompilationHash":"4c97b8867ce8cc5e8d2c","result":{"data":{"site":{"siteMetadata":{"title":"Istio By Example","author":"Megan O'Keefe"}},"markdownRemark":{"id":"e28e2324-3470-54cc-a29c-5534092f1050","excerpt":"Running containerized services in Kubernetes can add lots of benefits, including autoscaling, dependency isolation, and resource optimization. Adding Istio to…","html":"<p>Running containerized services in Kubernetes can add lots of benefits, including autoscaling, dependency isolation, and resource optimization. Adding Istio to your Kubernetes environment can radically simplify metrics aggregation and policy management, even if you’re operating lots of containers.</p>\n<p>But what about stateful services, or legacy applications are running in virtual machines? Or what if you’re migrating from VMs to containers? Have no fear: you can integrate virtual machines into your Istio service mesh. Let’s see how.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5aa6be26035def23daebd8254eb4399b/76ebb/call-flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.20622041920217%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAFxGAABcRgEUlENBAAABlElEQVQoz5WTX3PSQBTF86n9Fn4Vnxyf1AdFHa3FEQqB0kL+GPKfkCwhDdnNzw20Cm1nxDtz5t59yNk9554YbdvyL3T1eH7o6gjd2eCMenKJ+kv+uIwwK/HTDV4i9j1al4SiItpU/IrF/uYT8qP5rpFMkpxZWjDVPRBbjImTYmq4ccHEXZGVNcUnl3Ka4OVbpFRIpWikZKc7smXz0YG8JpcNg2CFr4luVgXDMMMYWQnDRYxpp/ywYsbfHBozoRnHzH4u6ZlL3vVtTCvn6yzi9sOCnZNTffcxvRVf3IjrNKfnhAweCD+PPG69jEtN/P71mNpa0/iCCz0vsi3jucvLVy8Y2HOu3twgxR1brWJoJ3u5oban0vIXmcCYapmd1FTLm2nSoqhoLn12/YBY+3soxZX9lloKaED0HNqlQChJf5ky10SjKNNYY3TGW0GOFeY4YYGvSYJ72FGhvVMnSzk+Kb3tzj+vKLHWgk3dYHTrPxjfHsxv1J5kp3v3wZ+86dc8l88nsTkng88G+4j4JNj/86ecU78BmApPCp+f/YoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"call flow\"\n        title=\"call flow\"\n        src=\"/static/5aa6be26035def23daebd8254eb4399b/b9e4f/call-flow.png\"\n        srcset=\"/static/5aa6be26035def23daebd8254eb4399b/cf440/call-flow.png 148w,\n/static/5aa6be26035def23daebd8254eb4399b/d2d38/call-flow.png 295w,\n/static/5aa6be26035def23daebd8254eb4399b/b9e4f/call-flow.png 590w,\n/static/5aa6be26035def23daebd8254eb4399b/f9b6a/call-flow.png 885w,\n/static/5aa6be26035def23daebd8254eb4399b/2d849/call-flow.png 1180w,\n/static/5aa6be26035def23daebd8254eb4399b/76ebb/call-flow.png 2958w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>In this example, we are running a web application for a local library. This web app has multiple backends, all running in a Kubernetes cluster. One of our Kubernetes workloads, <code class=\"language-text\">inventory</code>, talks to a PostgreSQL database, and writes a record for each new book added to the library. This database is running in a virtual machine in another cloud region.</p>\n<p>In order to get the full Istio functionality for PostgreSQL, our VM-based database, we need to install the Istio sidecar proxy on the VM, and configure it to talk to the Istio control plane running in the cluster. (Note that this is different from adding external <a href=\"/external-services\">ServiceEntries</a>.) We can add our Postgres database to the mesh with three steps. You can follow along with the commands in the <a href=\"https://github.com/askmeegs/postgres-library/tree/0241acce9d7e2cede0de8ac9baa1338624f716eb#-postgres-library\">demo on GitHub</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3f551cc3dee50629373db7558e62170c/efc60/architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.55693805788477%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAFxGAABcRgEUlENBAAACFElEQVQoz1WTSZObMBCF/evnjyT3OeeUyjFVs+927PGKWY1AIGQM0pfGrokdqpqGlvT6ve7WCDzGePZ7z/nxF/707f3XS1zf4juLd534Bt9W/06MlPJcXXmurz07+Y5SSDJPvvOUBZQSa9sT8IB3PJyPcdkrXq9wyTMufsSbTBIdGB0Onu/f4MdPT1B5Eu1ZK6hbeIk9byHo8szdNRmm1lhrsU1D3xt6V9LvY0mmGQ2bagGJ5NB9AoUA2c4R5yX6U7Ec79iEFY2pqOuGPFqyWi5IkphNEKOKDxr7wMGujuxHg5RCGCXC7jFxrEvPQvWk2tJOUvRUkcm/Ezld79jr5AiYS8K6UnTtO66b49rgDDjUKtxZVmnFPDH8Sa3ELLtSGBUHkXbRr14LWE7nZL1eCoGStSSvjEg81CfASsNsU/IyT/kMC6K4xN1GVItckjQ8jRX30w/iomFf5ei7Nd12ykzAPlLNbZgTqBw6cwacCuBsq9gWhrubFZ3UL3/Y8j7JGS81N5NfxFXD5nWOfoswLwm/JyGLQlSpmp0Wmd0lw6DkfZWxEHaLUGGfY4pZRla2WHMh2ciagHXLik8BWpVSImWkqReAA9swaVnHhk3cSIf3xKolUuLTDqWOxcPJHDqb4WTmOJTS+R1BuiXIIhodfdWQ4y0ZEtQVR7bD3A1WiRUS/2+wvRPr5Zb0w5UZJvNkQ0w2/AVo6klzRTj/SAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"architecture\"\n        title=\"architecture\"\n        src=\"/static/3f551cc3dee50629373db7558e62170c/b9e4f/architecture.png\"\n        srcset=\"/static/3f551cc3dee50629373db7558e62170c/cf440/architecture.png 148w,\n/static/3f551cc3dee50629373db7558e62170c/d2d38/architecture.png 295w,\n/static/3f551cc3dee50629373db7558e62170c/b9e4f/architecture.png 590w,\n/static/3f551cc3dee50629373db7558e62170c/f9b6a/architecture.png 885w,\n/static/3f551cc3dee50629373db7558e62170c/2d849/architecture.png 1180w,\n/static/3f551cc3dee50629373db7558e62170c/efc60/architecture.png 3697w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li><strong><a href=\"https://github.com/askmeegs/postgres-library#5-allow-pod-ip-traffic-to-the-vm\">Create a firewall rule</a> for pod-to-VM traffic</strong>. This allows traffic from the Kubernetes pod CIDR range directly into our VM-based workload.</li>\n<li><strong><a href=\"https://github.com/askmeegs/postgres-library#6-prepare-a-clusterenv-file-to-send-to-the-vm\">Install Istio</a> on the VM</strong>. Copy the service account keys, and the ports the VM service exposes (in this case, PostgreSQL client port <code class=\"language-text\">5432</code>). Update the <code class=\"language-text\">/etc/hosts</code> on the VM to route <code class=\"language-text\">istio.pilot</code> and <code class=\"language-text\">istio.citadel</code> traffic through the Istio IngressGateway running on the cluster. Then, install the Istio sidecar proxy and node agent on the VM. The node agent is responsible for generating client certificates to mount into the sidecar proxy, for mutual TLS authentication. Start the proxy and node agent using <code class=\"language-text\">systemctl</code>.</li>\n<li><strong><a href=\"https://github.com/askmeegs/postgres-library#8-register-the-vm-with-istio-running-on-the-gke-cluster\">Register the VM</a> workload with Kubernetes</strong>. We need two Kubernetes resources to add our Postgres database to the mesh. The first is a <code class=\"language-text\">ServiceEntry</code>. This will route the Kubernetes DNS name to the virtual machine IP address. Finally, we need a Kubernetes <code class=\"language-text\">Service</code> to create that DNS entry. This is what will allow our client pod to <a href=\"https://github.com/askmeegs/postgres-library/blob/master/main.go#L39\">start a database connection</a> at <code class=\"language-text\">postgres-1-vm.default.svc.cluster.local</code>. We can use the <code class=\"language-text\">istioctl register</code> command to do this.</li>\n</ol>\n<p>We can now verify that the Kubernetes-based client can successfully write to the database, by viewing the pod logs:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">postgres-library-6bb956f86b-dt94x server ✅ inserted Fun Home\npostgres-library-6bb956f86b-dt94x server ✅ inserted Infinite Jest\npostgres-library-6bb956f86b-dt94x server ✅ inserted To the Lighthouse</code></pre></div>\n<p>And we can verify that the sidecar proxy running on the VM is intercepting inbound traffic on port <code class=\"language-text\">5432</code>, by viewing the Envoy access logs on the VM.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ tail /var/log/istio/istio.log\n\n[2019-11-14T19:09:00.174Z] &quot;- - -&quot; 0 - &quot;-&quot; &quot;-&quot; 268 441 194 - &quot;-&quot; &quot;-&quot; &quot;-&quot; &quot;-&quot;\n&quot;127.0.0.1:5432&quot; inbound|5432|tcp|postgresql-1-vm.default.svc.cluster.local\n127.0.0.1:54104 10.128.0.14:5432 10.24.2.23:40190\noutbound_.5432_._.postgresql-1-vm.default.svc.cluster.local -</code></pre></div>\n<p>We can also see TCP metrics flowing in the Kiali service graph:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cfd71c3c1d641f6486d87cdbfb40c7b8/1589a/kiali.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.86520376175549%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAuUlEQVQoz61S0Q6CMAzk/z/JT/AVlwWToTi3lylmxhAIjJMOMZOMwINNbm2663Jtl+DPlkxB3/dfH8ahLXFCXhIm54gVO+cGxHn+wbmKmKKY2iWeV1jXNTjnyLIMQggcBy+l9ISu6zzITnmO9MDAGMOlKKCUgrX2VyEd1EbTNKiqCveyhDYjbvYFeVVQWsM8njClxW6fgoszXNuiHUC1qy1TikDkaU5j/Llba3k+4C22uJTYd9iK2LLedxPE51JRirYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kiali\"\n        title=\"kiali\"\n        src=\"/static/cfd71c3c1d641f6486d87cdbfb40c7b8/b9e4f/kiali.png\"\n        srcset=\"/static/cfd71c3c1d641f6486d87cdbfb40c7b8/cf440/kiali.png 148w,\n/static/cfd71c3c1d641f6486d87cdbfb40c7b8/d2d38/kiali.png 295w,\n/static/cfd71c3c1d641f6486d87cdbfb40c7b8/b9e4f/kiali.png 590w,\n/static/cfd71c3c1d641f6486d87cdbfb40c7b8/f9b6a/kiali.png 885w,\n/static/cfd71c3c1d641f6486d87cdbfb40c7b8/2d849/kiali.png 1180w,\n/static/cfd71c3c1d641f6486d87cdbfb40c7b8/1589a/kiali.png 1276w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>From here, we can use any Istio traffic or security policies to our multi-environment service mesh. For instance, we can encrypt all traffic between the cluster and the VM, by adding a mesh-wide mutual TLS policy:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"authentication.istio.io/v1alpha1\"</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"MeshPolicy\"</span>\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"default\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">peers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mtls</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"networking.istio.io/v1alpha3\"</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DestinationRule\"</span>\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"default\"</span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"istio-system\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*.local\"</span>\n  <span class=\"token key atrule\">trafficPolicy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> ISTIO_MUTUAL</code></pre></div>\n<p>To learn more:</p>\n<ul>\n<li><a href=\"https://github.com/askmeegs/postgres-library\">Run this example in your environment</a></li>\n<li><a href=\"https://github.com/GoogleCloudPlatform/istio-samples/tree/master/mesh-expansion-gce\">Try another example</a></li>\n<li><a href=\"https://istio.io/docs/examples/virtual-machines/single-network/\">See the Istio documentation</a></li>\n</ul>","frontmatter":{"title":"virtual machines","date":"May 01, 2015"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/virtual-machines/","previous":null,"next":{"fields":{"slug":"/locality-load-balancing/"},"frontmatter":{"title":"locality load balancing"}}}}}