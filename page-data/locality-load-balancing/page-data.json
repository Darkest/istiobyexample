{"componentChunkName":"component---src-templates-example-js","path":"/locality-load-balancing/","webpackCompilationHash":"4c97b8867ce8cc5e8d2c","result":{"data":{"site":{"siteMetadata":{"title":"Istio By Example","author":"Megan O'Keefe"}},"markdownRemark":{"id":"3460e076-f1cb-5c27-8db5-bcee00397d63","excerpt":"If youâ€™re running a high-scale, global application, you might be running services in multiple regions. If you have multiple replicas of the same service, youâ€¦","html":"<p>If youâ€™re running a high-scale, global application, you might be running services in multiple regions. If you have multiple replicas of the same service, you may want to direct client requests to the closest server, in order to minimize latency. You might also want a way to handle failover if one region goes down, and direct traffic to the closest available service.</p>\n<p>Istio can help you automatically handle regional traffic using a feature called <strong>locality load balancing.</strong> Letâ€™s see how.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ecbb11b64aa2ac2aa426660e3a034bbb/4072e/default.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.34368308351178%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAFxGAABcRgEUlENBAAACa0lEQVQ4y32UCW/aQBCF+f//K5XaSOmVhMMlEDD4wvba4HPt/TqLIThRWtAyaD3z5r05PDGG/37MyMH8w3l8P7E/XWfIc8PpZHB3hs3GMJubN0drrzFxbAgCw35veH21MbzzEUBx8OHpNywd+P4Azhy+foFDBFoPSH1vzscmW68Ny+Vgj0dz9rkmnOgWvEON6lMOTYLqFAmZfFPiY4VKz/nPgZZZUQxKrLXH3ruuEZUXwF4LszjkVb+wb/d4vUe9OJD7AZFWHNUNsGk+r3OWcQM0Arg4eDxU98zaOYvomW6qOM09giQSoBtgWZrz/6Fe1xob0tR8BPRZtgs27ZZduYXHnHLqExUpeXauILkFrG6A4+6m6YhhJzV0k5yNXuE2WxbCcnNaE9Qiv44vkqEUpm017uhHhgP4pG0NSl0ySUPui2/cFXf8rH+wKlycRJgaj6XyWB335+bd5m+wqWIMaCkPfGflE3+qGdPmF77eiOSERPV01MR5w7FsibWPU02lCjZGn08a64tkI4Byp/xYUB10vICTR+W4EAV0ojPLBhZ2gOuih8ShtX75Cu16dBthHcbotr8wFGTlyQQnMs1lRBfuqKcZzSKgTmQu82uXoSolKJQNyFxMsqWeRTRzmdelxPVjwH0oazHFFAF9tKN6UjTPMo9J+gngI6ZMMKkknoU004R4HowARXIWSqHzpch+AWlEH1rGHrrML5IHwLqy2Z3B77gWUPHzfYkfS5amRNGwj3UNTS0bIQ9boW6HWVS/AWaZwU5F3Vz8mg7d9URhf2uKXXg7mJaJDRjscOz9sB3DS0Ip3j0fn+uQ/wX/BNYXcPkE6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"default\"\n        title=\"default\"\n        src=\"/static/ecbb11b64aa2ac2aa426660e3a034bbb/b9e4f/default.png\"\n        srcset=\"/static/ecbb11b64aa2ac2aa426660e3a034bbb/cf440/default.png 148w,\n/static/ecbb11b64aa2ac2aa426660e3a034bbb/d2d38/default.png 295w,\n/static/ecbb11b64aa2ac2aa426660e3a034bbb/b9e4f/default.png 590w,\n/static/ecbb11b64aa2ac2aa426660e3a034bbb/f9b6a/default.png 885w,\n/static/ecbb11b64aa2ac2aa426660e3a034bbb/2d849/default.png 1180w,\n/static/ecbb11b64aa2ac2aa426660e3a034bbb/4072e/default.png 3736w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>Here, we have two Kubernetes clusters running in two different cloud regions, <code class=\"language-text\">us-central</code> and <code class=\"language-text\">us-east</code>.\nThe Istio control plane is running in <code class=\"language-text\">us-east</code>, and we have set up <a href=\"https://github.com/GoogleCloudPlatform/istio-samples/tree/191859c03e73da7e98d451c967cefe24101d1933/multicluster-gke/single-control-plane#demo-multicluster-istio--single-control-plane\">single control plane</a> Istio multicluster, so that services running in both clusters can reach each other.</p>\n<p>When we started both clusters, the cloud provider added region-specific <code class=\"language-text\">failure-domain</code> labels to the Kubernetes nodes:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">failure-domain.beta.kubernetes.io/region: us-central1\nfailure-domain.beta.kubernetes.io/zone: us-central1-b</code></pre></div>\n<p>Istio will populate requests with these locality labels, allowing Istio to redirect requests to the closest available region.</p>\n<p>Both clusters are running an Istio-injected service called <code class=\"language-text\">echo</code>, which prints its location when accessed on port <code class=\"language-text\">80</code>. The central cluster is also running a <code class=\"language-text\">loadgen</code> service that calls <code class=\"language-text\">echo.default.svc.cluster.local:80</code> every second.</p>\n<p>By default, the Kubernetes Service behavior is round-robin, between the two <code class=\"language-text\">echo</code> servers on both clusters:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ðŸŒŠ Hello World! - EAST\n$ âœ¨ Hello World! - CENTRAL\n$ ðŸŒŠ Hello World! - EAST\n$ âœ¨ Hello World! - CENTRAL</code></pre></div>\n<p>We can enable locality load balancing by adding an <a href=\"https://istio.io/docs/reference/config/networking/v1alpha3/destination-rule/#OutlierDetection\">outlier detection</a> Istio DestinationRule on the <code class=\"language-text\">east</code> cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.istio.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> DestinationRule\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> echo<span class=\"token punctuation\">-</span>outlier<span class=\"token punctuation\">-</span>detection\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> echo.default.svc.cluster.local\n  <span class=\"token key atrule\">trafficPolicy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">connectionPool</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">tcp</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">maxConnections</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">http2MaxRequests</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n        <span class=\"token key atrule\">maxRequestsPerConnection</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">outlierDetection</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">consecutiveErrors</span><span class=\"token punctuation\">:</span> <span class=\"token number\">7</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\n      <span class=\"token key atrule\">baseEjectionTime</span><span class=\"token punctuation\">:</span> 30s</code></pre></div>\n<p>Now, all <code class=\"language-text\">loadgen</code> requests are routed to the closest instance of <code class=\"language-text\">echo</code>, running in <code class=\"language-text\">us-central</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ âœ¨ Hello World! - CENTRAL\n$ âœ¨ Hello World! - CENTRAL\n$ âœ¨ Hello World! - CENTRAL</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/938519d153fa72945f4be94f2a0f96ec/7570e/locality.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.3732590529248%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAFxGAABcRgEUlENBAAACf0lEQVQ4y32UC2/aQBCE8///V6q2Uqo0TQIFlKhgDPh1Z+MXtm+/rm0caNoU6biVb252dnbtGxHhf7/r8zGWf2Im3E3/V1VCkghpJixXwuurcHcntK38dSHLwPOEzUaYz2WIr4lvnNPDNTz9gNUCvt/DyxK+fAJ/C3U9kTIkCENhvR6JVpr8cJABMyW/sQZMWWJdQtIaUmcxWFIS4rzAJAMdTQO7nVAUl1WWQp5rZakQBIJzSni0sK32rE4L/GaL73zqRUy63RO0CZkZCU8n9OLHXlvl6TotOddgXfh8Lm55bB5ZRTNklnGc++zjYPBsIjRmbMrk6cVbGc66jpFwU/r8rJ/xWo9tvkEeLPmDR5DFZOmFsFcx+TntU2wMI2Ff8q4Mea5VXb1k2Sy12zFRvmdbBxzfSpYz4VnVRwr7ptSNG7IUrmRez/nVrXlungYrjvZKoTl3fBqTq3hUqB72QXNSQnHMy0fujp/5mt8yq74riXtTdVHokK7VrdNdW08fNxeFRj1qMovkvpb6glQRVbKHPKIpUswfCjVxFSJFrCvU0hJcHA27CY50biK0AQQ62amHJB7Vt4RmEQyJTPqO0CyR+EVfmTWd71F8DWk3CTZMrxQaVXR4QDRTt/N0DlNOTzqPuxB7fE+4wJmNGpZRPyxpDjX1Dx/jm4vCkzlANEd6hbqqmZa78mm0xW8lq10m6QlXyHGPZBtcsqW839N6ATawZ4X9hFeF+qBll0HPrvdVltjhub320GpPnU56eRixbTpinXod1bTD2CgoihWsuF5tn6DvvNU4VN+jaByM/uUPgvG5Sa+wuhLFx8n5a9PPZdPIh8u5y+T1c/YxbsT8BrhLJFDfRuQGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"locality\"\n        title=\"locality\"\n        src=\"/static/938519d153fa72945f4be94f2a0f96ec/b9e4f/locality.png\"\n        srcset=\"/static/938519d153fa72945f4be94f2a0f96ec/cf440/locality.png 148w,\n/static/938519d153fa72945f4be94f2a0f96ec/d2d38/locality.png 295w,\n/static/938519d153fa72945f4be94f2a0f96ec/b9e4f/locality.png 590w,\n/static/938519d153fa72945f4be94f2a0f96ec/f9b6a/locality.png 885w,\n/static/938519d153fa72945f4be94f2a0f96ec/2d849/locality.png 1180w,\n/static/938519d153fa72945f4be94f2a0f96ec/7570e/locality.png 3590w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>If we delete the <code class=\"language-text\">echo</code> Deployment running in <code class=\"language-text\">us-central</code>, Istio will redirect <code class=\"language-text\">loadgen</code> requests to the <code class=\"language-text\">echo</code> Pod running in <code class=\"language-text\">us-east</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ðŸŒŠ Hello World! - EAST\n$ ðŸŒŠ Hello World! - EAST\n$ ðŸŒŠ Hello World! - EAST</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f926ea8027cb05d1c3bece596305f312/caaa1/failover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.25171561899533%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAFxGAABcRgEUlENBAAACdklEQVQ4y3VUaXPbIBT0//9bmem3NI3bRPERy3V0WhfoRqC3fUh2ZKcTNAgEy/KWfWhFRPiu2Knr9Nynb3DL+Mq++p4gBEGWhP2e4LwRDgcLopsFcz8MCWnKGIdwPBKMWTAWthpHgvcBbF4Bdw+sn4DdG/DMbZ4DwzAv0JpQVcD7O8H3CS8vM2HJQbQtfUa5kgIougaxCRGoAIJyCEh+ChR1Dztvo7PkVWUjApTC1A6DVQecz0ukq1oCfhdhpzYIdcCkPrp1jCpLkWiB8kJYFDPJLP22go/LKsBC+NGG+NU+wjUuTtEeoyNRb0OcywylXAitbNu/mnX1oijoMnch9NoIT90jHPWKoPb4IEt0LkfYCdQXwpwXDZ+EdOfuHaGVlPUSsQ4hWOJ22OBv7bLcGHGfIy2GCWhxpJd8IqJP92fCeeOVTRd1cdIbPPxofuChecC6X+PYeNhnMRIKsU1DfHQBirG4y9MpQoElwulAew0zlHirfsJvtjgwWdhtULY1Kmn3VYjzHj3bmvQnHBrOMa1AY8uTNYpUQZtrhCXbL1O26h2m5IRsMiiHv6sGuq2m3W2x6WOahsNxoeWJcQGUm2D0I4hEfiEUZ74CnMl9Bn08otsIqG0ExeGJyZRxllXzK3rmzUKM0Qm9c8bgRMhPOWbFt4SJAxokjO+h/V1g2J2hyhtCbnVlHdyyVIUx43z9w5g1n6tXQI83hLriayB2LOcAcAqNKUtuEuiuvhDSFKHpO8bx/RSMq08gkfH9DL5IZmDT0HRnleLaj+y64W+Dup4T+prY9s7e4ZRhdw3/LMaF0AIsqZT/VztuF9vyHc6O2Z/GNcn/AbYp1e8nLXMJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"failover\"\n        title=\"failover\"\n        src=\"/static/f926ea8027cb05d1c3bece596305f312/b9e4f/failover.png\"\n        srcset=\"/static/f926ea8027cb05d1c3bece596305f312/cf440/failover.png 148w,\n/static/f926ea8027cb05d1c3bece596305f312/d2d38/failover.png 295w,\n/static/f926ea8027cb05d1c3bece596305f312/b9e4f/failover.png 590w,\n/static/f926ea8027cb05d1c3bece596305f312/f9b6a/failover.png 885w,\n/static/f926ea8027cb05d1c3bece596305f312/2d849/failover.png 1180w,\n/static/f926ea8027cb05d1c3bece596305f312/caaa1/failover.png 3643w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>We can also add a percentage-based load balancing rule for mesh-wide traffic, in the global Istio installation settings:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    localityLbSetting:\n      distribute:\n      - from: us-central1/*\n        to:\n          us-central1/*: 20\n          us-east1/*: 80</code></pre></div>\n<p>Now, all services running in both clusters will share requests 80/20, between <code class=\"language-text\">us-east</code> and <code class=\"language-text\">us-central</code>. No VirtualServices are needed.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ðŸŒŠ Hello World! - EAST\n$ ðŸŒŠ Hello World! - EAST\n$ ðŸŒŠ Hello World! - EAST\n$ ðŸŒŠ Hello World! - EAST\n$ âœ¨ Hello World! - CENTRAL</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a1ecb7dd29b7381cae395f758e69f395/dd1f1/splittraffic.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.5488613433266%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAFxGAABcRgEUlENBAAACsElEQVQ4y31Ui1biMBTk/79rPe5DxYUFAUGFQimPJn2mSR+ZnbSg4DkK5zahuZ3OnTuXnrUW330uz79LPef13EUVFqGwSBKL+aKLft9CKfuefH7ArQueR5HFYNDti+LjrNc0Fss3YDQEFnPg8QF4eQZ+3wKrJaC1fWdW10CeW0ynHeBoZOF5tr1XVYDD6kkBhJmCrCIIEyPierQRQn5jk+F4AMrKIVoEgcXxyIoUEMfdmqbd/nCwXAmYRsCmCDAvp1iXHrYIYJYS8XoHBxtJApYdoJRnHe2nQMswIlYv4+Ut36Cv7rCslpiLCeqRRDrcQuZ7yPgDUAhXWrd3wJ22nRxaXwAuCfhb/cTYjPEm57DjGOmjD5EG14CSgHXDXXPVpCtAV7KnAszMBEG5xaJaINrtIDcEg0BMjeuqYxGzZGKdfPIFQ6dRbgzC+sCy7/FX9TGtJpjXcwT1BoEokBiFEhqrMMaP5AZL80qgphW0Y2hbN7jO95zQmiU9k9mNukVmi/aNpqlR8Ds7Bm3TDvUOk6OPX9kd7vXDJdGOoTkxlLyUWcL+b+ALJir6RFM4zTdVGRKe21PJTh735Er+QZl49E0IS6uBVjNMjKRj6EQXW4DNQLJrgYvBHvppTfGoYmubphVPELCKA0C8Mo9r5kGPfZjxDialxUR1Agw3QPCIptij3qygFwmKfz5sSNukFz4kYJ3sYbd9WFZQ+wR82qLyMuSzNeKkOTP0+VbaRUew0ocaSKg7MlTiyjYtoGMoX2CbkrmsZhhAD0MoNwhR3QFWCedJTgk6Y8vJNmOdUdCW3Gp8Adjk9JHksAtGtmLwd3xAmR5ZMhmGIe+ltn2I7oEpGhhd0QYVStNwRj8A2znOXd4pdJdbljVSltt22f1FCdG1/HM4Rm7gz+bNsq9zXbix/A/aIh+xtESi/gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"split\"\n        title=\"split\"\n        src=\"/static/a1ecb7dd29b7381cae395f758e69f395/b9e4f/splittraffic.png\"\n        srcset=\"/static/a1ecb7dd29b7381cae395f758e69f395/cf440/splittraffic.png 148w,\n/static/a1ecb7dd29b7381cae395f758e69f395/d2d38/splittraffic.png 295w,\n/static/a1ecb7dd29b7381cae395f758e69f395/b9e4f/splittraffic.png 590w,\n/static/a1ecb7dd29b7381cae395f758e69f395/f9b6a/splittraffic.png 885w,\n/static/a1ecb7dd29b7381cae395f758e69f395/2d849/splittraffic.png 1180w,\n/static/a1ecb7dd29b7381cae395f758e69f395/dd1f1/splittraffic.png 3469w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>To learn more about Locality-based load balancing with Istio, see the <a href=\"https://istio.io/docs/ops/traffic-management/locality-load-balancing/\">Istio documentation</a>.</p>","frontmatter":{"title":"locality load balancing","date":"May 01, 2015"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/locality-load-balancing/","previous":{"fields":{"slug":"/virtual-machines/"},"frontmatter":{"title":"virtual machines"}},"next":{"fields":{"slug":"/response-headers/"},"frontmatter":{"title":"modify response headers"}}}}}